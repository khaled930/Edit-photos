<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Editor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h1>Image Editing Platform</h1>

<form action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept="image/*" required>
    <button type="submit">Upload Image</button>
</form>

{% if image_url %}
<hr>

<h2>Crop Image (Editable Box)</h2>

<!-- إطار القص -->
<div id="crop-frame">
    <img id="image" src="{{ image_url }}">

    <div id="crop-box" style="display:none;">
        <span class="handle tl"></span>
        <span class="handle tm"></span>
        <span class="handle tr"></span>
        <span class="handle ml"></span>
        <span class="handle mr"></span>
        <span class="handle bl"></span>
        <span class="handle bm"></span>
        <span class="handle br"></span>
    </div>
</div>

<br>

<button onclick="enableCrop()">Crop Mode</button>
<button onclick="submitCrop()">Save Crop</button>

<form action="/rotate" method="post" style="display:inline;">
    <input type="hidden" name="image_url" value="{{ image_url }}">
    <select name="angle">
        <option value="90">90°</option>
        <option value="180">180°</option>
        <option value="270">270°</option>
    </select>
    <button type="submit">Rotate</button>
</form>

<form id="crop-form" action="/crop" method="post">
    <input type="hidden" name="image_url" value="{{ image_url }}">
    <input type="hidden" name="x" id="x">
    <input type="hidden" name="y" id="y">
    <input type="hidden" name="width" id="width">
    <input type="hidden" name="height" id="height">
</form>

<hr>

<!-- JPEG Compression -->
<h2>JPEG Compression</h2>

<form action="/compress" method="post">
    <input type="hidden" name="image_url" value="{{ image_url }}">

    <label>Compression Quality (1 - 95)</label><br>
    <input type="number" name="quality" value="70" min="1" max="95" required>

    <br><br>
    <button type="submit">Compress Image</button>
</form>

{% if compressed_url %}
<hr>

<h3>Compressed Result</h3>

<p>
    Size Before: {{ stats.before_kb }} KB <br>
    Size After: {{ stats.after_kb }} KB <br>
    Compression Ratio: {{ stats.ratio }}
</p>

<img src="{{ compressed_url }}" style="max-width:400px; border:1px solid #ccc;"><br><br>

<a href="{{ compressed_url }}" download>
    <button>Download Compressed Image</button>
</a>
{% endif %}

{% endif %}

<script>
const cropBox = document.getElementById("crop-box");
const img = document.getElementById("image");

let startX, startY, mode;
let box = {};
const MIN_SIZE = 40;

/* ===== Enable Crop ===== */
function enableCrop() {
    cropBox.style.display = "block";
    cropBox.style.left = "50px";
    cropBox.style.top = "50px";
    cropBox.style.width = "200px";
    cropBox.style.height = "150px";
}

/* ===== Mouse Down ===== */
cropBox.addEventListener("mousedown", e => {
    e.preventDefault();

    mode = e.target.classList.contains("handle")
        ? e.target.classList[1]
        : "move";

    startX = e.clientX;
    startY = e.clientY;

    box = {
        x: cropBox.offsetLeft,
        y: cropBox.offsetTop,
        w: cropBox.offsetWidth,
        h: cropBox.offsetHeight
    };

    document.addEventListener("mousemove", resize);
    document.addEventListener("mouseup", stop);
});

/* ===== Resize / Move ===== */
function resize(e) {
    let dx = e.clientX - startX;
    let dy = e.clientY - startY;

    let x = box.x;
    let y = box.y;
    let w = box.w;
    let h = box.h;

    if (mode === "move") {
        x += dx;
        y += dy;
    }

    if (mode.includes("r")) w = Math.max(MIN_SIZE, box.w + dx);
    if (mode.includes("l")) {
        w = Math.max(MIN_SIZE, box.w - dx);
        x = box.x + dx;
    }

    if (mode.includes("b")) h = Math.max(MIN_SIZE, box.h + dy);
    if (mode.includes("t")) {
        h = Math.max(MIN_SIZE, box.h - dy);
        y = box.y + dy;
    }

    cropBox.style.left = x + "px";
    cropBox.style.top = y + "px";
    cropBox.style.width = w + "px";
    cropBox.style.height = h + "px";
}

/* ===== Stop ===== */
function stop() {
    document.removeEventListener("mousemove", resize);
    document.removeEventListener("mouseup", stop);
}

/* ===== Submit Crop ===== */
function submitCrop() {
    const imgRect = img.getBoundingClientRect();
    const boxRect = cropBox.getBoundingClientRect();

    const scaleX = img.naturalWidth / imgRect.width;
    const scaleY = img.naturalHeight / imgRect.height;

    document.getElementById("x").value =
        Math.round((boxRect.left - imgRect.left) * scaleX);
    document.getElementById("y").value =
        Math.round((boxRect.top - imgRect.top) * scaleY);
    document.getElementById("width").value =
        Math.round(boxRect.width * scaleX);
    document.getElementById("height").value =
        Math.round(boxRect.height * scaleY);

    document.getElementById("crop-form").submit();
}
</script>

</body>
</html>
